// @graph-mind
// Remove the previous line to stop Ada from updating this file
"use strict";var e=require("tslib"),t=require("path"),r=require("pkg-up"),n=require("sade"),a=require("fs-extra"),s=require("rollup"),o=require("@babel/core"),i=require("@rollup/plugin-commonjs"),u=require("@rollup/plugin-json"),l=require("@rollup/plugin-node-resolve"),p=require("@rollup/plugin-replace"),c=require("rollup-plugin-typescript2"),d=require("typescript"),f=require("@rollup/plugin-babel"),v=require("lodash.merge"),g=require("chalk"),m=require("npm-packlist"),h=require("pkg-dir"),_=require("sort-package-json"),b=require("tar");function y(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var w=y(t),k=y(r),j=y(n),x=y(a),D=y(i),E=y(u),R=y(l),q=y(p),P=y(c),S=y(d),A=y(v),C=y(g),F=y(m),O=y(h),I=y(_),T=y(b),B=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=[];return t.forEach((function(t){t.forEach((function(t){var r=n.findIndex((function(e){return e.file.resolved===t.file.resolved}));-1!==r?n[r]=o.createConfigItem([n[r].file.resolved,A.default(n[r].options,t.options)],{type:e}):n.push(t)}))})),n},J=function(t,r){return r.map((function(r){var n=r.name,a=e.__rest(r,["name"]);return o.createConfigItem([require.resolve(n),a],{type:t})}))},N=f.createBabelInputPluginFactory((function(){return{options:function(t){return{customOptions:t.custom,pluginOptions:e.__rest(t,["custom"])}},config:function(e,t){var r=t.customOptions,n=J("plugin",[{name:"babel-plugin-macros"},{name:"babel-plugin-annotate-pure-calls"},{name:"babel-plugin-dev-expression"},{name:"babel-plugin-polyfill-regenerator",method:"usage-pure"},{name:"@babel/plugin-proposal-class-properties",loose:!0}].filter(Boolean)),a=e.options||{};a.presets=a.presets||[];var s=a.presets.findIndex((function(e){return e.file.request.includes("@babel/preset-env")}));if(-1!==s){var i=a.presets[s];a.presets[s]=o.createConfigItem([i.file.resolved,A.default({loose:!0,targets:r.targets},i.options,{modules:!1})],{type:"preset"})}else{var u=J("preset",[{name:"@babel/preset-env",targets:r.targets,modules:!1,loose:!0},{name:"@babel/preset-typescript"}]);a.presets=B("preset",u,a.presets)}return a.plugins=B("plugin",n,a.plugins||[]),a}}})),W={production:"production",development:"development"};function z(t){var r=[t.appDist+"/index",W[t.env],"js"].join("."),n=w.default.resolve(t.appRoot,"tsconfig.json"),a=S.default.readConfigFile(n,S.default.sys.readFile).config,s=S.default.parseJsonConfigFileContent(a,S.default.sys,"./").options;return{input:t.inputFile,external:function(e){return!e.startsWith("regenerator-runtime")&&!function(e,t){return!!e.startsWith(".")||!!w.default.isAbsolute(e)||!!t.some((function(t){return e.startsWith(t)}))}(e,t.internalPackages)},treeshake:{propertyReadSideEffects:!1},output:{file:r,format:"cjs",freeze:!1,esModule:Boolean(null==s?void 0:s.esModuleInterop),name:r,sourcemap:!1,globals:{react:"React","react-native":"ReactNative"},exports:"named"},plugins:[R.default({mainFields:["module","main"],extensions:e.__spreadArray(e.__spreadArray([],l.DEFAULTS.extensions),[".jsx"])}),D.default({include:/\/regenerator-runtime\//}),E.default(),{name:"shebang-fix",transform:function(e){var t=/^#!(.*)/,r=e.match(t);return r&&r[1],{code:e=e.replace(t,""),map:null}}},P.default({typescript:S.default,tsconfig:n,tsconfigDefaults:{exclude:["**/*.spec.ts","**/*.test.ts","**/*.spec.tsx","**/*.test.tsx","node_modules","bower_components","jspm_packages",t.appDist],compilerOptions:{jsx:"react"}},tsconfigOverride:{compilerOptions:{target:"esnext"}},check:"production"===t.env,useTsconfigDeclarationDir:Boolean(null==s?void 0:s.declarationDir)}),N({exclude:"node_modules/**",extensions:e.__spreadArray(e.__spreadArray([],o.DEFAULT_EXTENSIONS),["ts","tsx"]),passPerPreset:!0,custom:{targets:{node:"10"},format:"cjs"},babelHelpers:"bundled"}),q.default({preventAssignment:!0,"process.env.NODE_ENV":JSON.stringify(W[t.env])})]}}var K=function(e){console.log(C.default.gray(">")+" "+e)};function L(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:r=0,n=t,e.label=1;case 1:return r<n.length?[4,(0,n[r])()]:[3,4];case 2:e.sent(),e.label=3;case 3:return r++,[3,1];case 4:return[2]}}))}))}function U(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,a,o,i=this;return e.__generator(this,(function(u){switch(u.label){case 0:return K("Cleaning output directory"),[4,x.default.emptyDir(t.appDist)];case 1:u.sent(),r=[z({env:"production",inputFile:t.inputFile,appDist:t.appDist,appRoot:t.appRoot,internalPackages:t.internalPackages}),z({env:"development",inputFile:t.inputFile,appDist:t.appDist,appRoot:t.appRoot,internalPackages:t.internalPackages})],u.label=2;case 2:return u.trys.push([2,4,,5]),n=r.map((function(t){return function(){return e.__awaiter(i,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,s.rollup(t)];case 1:return[4,e.sent().write(t.output)];case 2:return e.sent(),[2]}}))}))}})),K("Building modules"),[4,L(n)];case 3:return u.sent(),[3,5];case 4:throw a=u.sent(),K("Error!"),a;case 5:return K("Copying config files"),(o=[".env.production.local",".env.production",".env.local",".env"].find((function(e){return x.default.existsSync(w.default.resolve(t.appRoot,e))})))&&x.default.copy(w.default.resolve(t.appRoot,o),w.default.resolve(t.appDist,".env")),(o=[".env.development.local",".env.development",".env.local",".env"].find((function(e){return x.default.existsSync(w.default.resolve(t.appRoot,e))})))&&x.default.copy(w.default.resolve(t.appRoot,o),w.default.resolve(t.appDist,".env.development")),[2]}}))}))}var V={PACKYAK_SERVER:function(t){var r=e.__assign({},t);return r.main="index.production.js",r.files=[r.main,"index.development.js","modules/"],r.scripts={},r.scripts.start="node index.production.js",r.scripts.dev="node index.development.js",r},RAZZLE:function(t){var r=e.__assign({},t);return r.main="server.js",r.files=[r.main,"assets.json","modules/","public/"],r.scripts={},r.scripts.start="node server.js",r},OTHER:function(t){var r,n=e.__assign({},t),a=["modules/"];return n.main&&a.push(n.main),(null===(r=n.files)||void 0===r?void 0:r.length)&&a.push.apply(a,n.files),n.files=Array.from(new Set(a)),n}};function Y(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,a,s,o,i,u,l,p=this;return e.__generator(this,(function(c){switch(c.label){case 0:return K("Packing modules"),r=O.default.sync(w.default.resolve(t.appRoot,"../")),r=w.default.resolve(r,"node_modules"),n=w.default.resolve(t.appDist,"modules"),a=w.default.resolve(t.appDist,"package.json"),s=w.default.resolve(t.appRoot,"package.json"),[4,x.default.readJson(s)];case 1:o=c.sent(),i=[],Object.entries(o.dependencies).forEach((function(e){var r=e[0];(e[1].startsWith("git+https")||t.internalPackages.some((function(e){return r.startsWith(e)})))&&i.push(r)})),c.label=2;case 2:return c.trys.push([2,4,,5]),[4,Promise.all(i.map((function(t){return e.__awaiter(p,void 0,void 0,(function(){var a,s,i;return e.__generator(this,(function(e){switch(e.label){case 0:return a=w.default.resolve(r,t),s=w.default.resolve(n,t),i=w.default.resolve(s,"package.tgz"),[4,x.default.ensureDir(s)];case 1:return e.sent(),[4,F.default({path:a}).then((function(e){return T.default.create({prefix:"package/",cwd:a,file:i,gzip:!0},e)}))];case 2:return e.sent(),o.dependencies[t]="file:./modules/"+t+"/package.tgz",[2]}}))}))})))];case 3:return c.sent(),[3,5];case 4:throw u=c.sent(),K("Error!"),u;case 5:return delete o.devDependencies,delete o.typings,V[t.appType]&&(o=V[t.appType](o)),o.files&&o.files.sort(),l=I.default(o),[4,x.default.writeJson(a,l,{spaces:2})];case 6:return c.sent(),[2]}}))}))}var H=j.default("PackYak");function M(e){return e.split(",").map((function(e){return e.trim()})).filter(Boolean)}H.version("1.0.0"),H.command("build server [dir]").option("-o, --output","Change the name of the output directory","").option("--internal","Internal package scopes","").action((function(t,r){return e.__awaiter(void 0,void 0,void 0,(function(){var n,a,s,o;return e.__generator(this,(function(e){switch(e.label){case 0:if(n=t?w.default.resolve(t):w.default.join(process.cwd(),"./src/index.ts"),!/\.(js|ts)$/.test(n))throw new Error("Input must be a JavaScript or TypeScript file.");if(!(s=k.default.sync({cwd:n})))throw new Error("Package.json not found.");if(s=w.default.resolve(s,"../"),!(a=r.output?r.output:w.default.resolve(s,"dist")))throw new Error("Output folder not found.");return(o=M(r.internal)).push("@local/"),[4,U({inputFile:n,appDist:a,appRoot:s,internalPackages:o})];case 1:return e.sent(),[4,Y({appDist:a,appRoot:s,internalPackages:o,appType:"PACKYAK_SERVER"})];case 2:return e.sent(),K("Success!"),[2]}}))}))})),H.command("pack [dir]").option("-o, --output","Change the name of the output directory","").option("-t, --type","Application type being packaged","packyak-server").option("--internal","Internal package scopes","").action((function(t,r){return e.__awaiter(void 0,void 0,void 0,(function(){var n,a,s,o;return e.__generator(this,(function(e){switch(e.label){case 0:if(n=t?w.default.resolve(t):w.default.join(process.cwd(),"./src/index.ts"),!/\.(js|ts)$/.test(n))throw new Error("Input must be a JavaScript or TypeScript file.");if(!(s=k.default.sync({cwd:n})))throw new Error("Package.json not found.");if(s=w.default.resolve(s,"../"),!(a=r.output?r.output:w.default.resolve(s,"dist")))throw new Error("Output folder not found.");return(o=M(r.internal)).push("@local/"),[4,Y({appType:r.type.replace(/-/gi,"_").toUpperCase(),appDist:a,appRoot:s,internalPackages:o})];case 1:return e.sent(),K("Success!"),[2]}}))}))})),H.parse(process.argv);