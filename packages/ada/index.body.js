// @graph-mind
// Remove the previous line to stop Ada from updating this file
"use strict";var e=require("tslib"),r=require("fs-extra"),t=require("path"),n=require("pkg-up"),s=require("sade"),a=require("chalk"),i=require("glob"),o=require("shelljs"),u=require("unzipper"),c=require("sort-package-json"),l=require("semver"),d=require("yaml"),p=require("command-exists"),f=require("simple-git");function v(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var g=v(r),h=v(t),_=v(n),m=v(s),w=v(a),b=v(i),k=v(o),y=v(u),R=v(c),j=v(l),D=v(d),F=v(f),x=function(e){console.log(w.default.gray(">")+" "+e)},q=function(e){console.log(w.default.blueBright("> "+e))};function E(r,t){var n=e.__assign({},r);n.dependencies=e.__assign(e.__assign({},r.dependencies||{}),t.dependencies||{}),n.devDependencies=e.__assign(e.__assign({},r.devDependencies||{}),t.devDependencies||{}),n.scripts=e.__assign(e.__assign({},r.scripts||{}),t.scripts||{}),n.workspaces=e.__spreadArray(e.__spreadArray([],r.workspaces||[]),t.workspaces||[]);var s={};return n.workspaces.forEach((function(e){s[e]=!0})),n.workspaces=Object.keys(s),n.engines=e.__assign(e.__assign({},r.engines||{}),t.engines||{}),n["graph-mind-version"]!==t["graph-mind-version"]&&(n["graph-mind-version-prev"]=n["graph-mind-version"]),n["graph-mind-version"]=t["graph-mind-version"],n=R.default(n)}var C=[{pattern:[".ts",".tsx",".js",".scss"],commentOpen:"//",commentClose:""},{pattern:[".html"],commentOpen:"\x3c!--",commentClose:"---\x3e"},{pattern:[".env.production.local",".env.development.local",".yml",".yaml",".Dockerfile"],commentOpen:"#",commentClose:""}];function J(r,t){return e.__awaiter(this,void 0,void 0,(function(){var n,s,a;return e.__generator(this,(function(e){switch(e.label){case 0:return(n=C.find((function(e){var r=e.pattern;return Boolean(r.find((function(e){return t.endsWith(e)})))})))?[3,2]:(q("Updating: "+t),[4,g.default.copy(r,t,{overwrite:!0})]);case 1:return e.sent(),[2];case 2:return[4,g.default.readFile(t,"utf8").catch((function(){return""}))];case 3:return(s=e.sent())?[3,5]:(q("Updating: "+t),[4,g.default.copy(r,t,{overwrite:!0})]);case 4:return e.sent(),[2];case 5:return a=n.commentOpen+" @graph-mind",s.includes(a)?(q("Updating: "+t),[4,g.default.copy(r,t,{overwrite:!0})]):[2];case 6:return e.sent(),[2]}}))}))}function O(r){return e.__awaiter(this,void 0,void 0,(function(){var t,n,s;return e.__generator(this,(function(a){switch(a.label){case 0:if(x("Checking for git"),!p.sync("git"))return[2];a.label=1;case 1:return a.trys.push([1,3,,4]),x("Checking for git repo"),[4,(t=F.default(r.appRoot)).status().then((function(){return!0})).catch((function(){return!1}))];case 2:return n=a.sent(),[3,4];case 3:return a.sent(),[2];case 4:if(!n)return[2];a.label=5;case 5:return a.trys.push([5,9,,10]),x("Committing refactor"),[4,t.status()];case 6:return s=a.sent(),[4,t.add(e.__spreadArray(e.__spreadArray([],s.not_added),s.deleted))];case 7:return a.sent(),[4,t.commit("refactor: rename files")];case 8:return a.sent(),[3,10];case 9:return a.sent(),x("Git Error!"),[3,10];case 10:return[2]}}))}))}var U=[{version:"<=1.12.1",steps:[function(r){return e.__awaiter(this,void 0,void 0,(function(){var t,n,s,a,i,o;return e.__generator(this,(function(e){switch(e.label){case 0:return t=h.default.resolve(r.appRoot,"src","servers","app"),n=h.default.resolve(r.appRoot,"packages","app-server"),[4,g.default.exists(t)];case 1:return e.sent()?[4,g.default.move(t,n,{overwrite:!0})]:[3,11];case 2:return e.sent(),[4,g.default.move(h.default.resolve(n,"api"),h.default.resolve(n,"src","api"),{overwrite:!0})];case 3:return e.sent(),[4,g.default.move(h.default.resolve(n,"entities"),h.default.resolve(n,"src","entities"),{overwrite:!0})];case 4:return e.sent(),[4,g.default.move(h.default.resolve(n,"gateways"),h.default.resolve(n,"src","gateways"),{overwrite:!0})];case 5:return e.sent(),[4,g.default.move(h.default.resolve(n,"server"),h.default.resolve(n,"src","server"),{overwrite:!0})];case 6:return e.sent(),[4,g.default.move(h.default.resolve(n,"usecases"),h.default.resolve(n,"src","usecases"),{overwrite:!0})];case 7:return e.sent(),[4,g.default.move(h.default.resolve(n,"index.ts"),h.default.resolve(n,"src","index.ts"),{overwrite:!0})];case 8:return e.sent(),[4,g.default.move(h.default.resolve(n,"config.ts"),h.default.resolve(n,"src","config.ts"),{overwrite:!0})];case 9:return e.sent(),[4,g.default.move(h.default.resolve(n,"server.ts"),h.default.resolve(n,"src","server.ts"),{overwrite:!0})];case 10:e.sent(),e.label=11;case 11:s=[{from:h.default.resolve(r.appRoot,"src","servers","lib","stdlib"),to:h.default.resolve(r.appRoot,"packages","server-stdlib","src")},{from:h.default.resolve(r.appRoot,"infrastructure","app"),to:h.default.resolve(r.appRoot,"infrastructure","app-server")}],a=0,i=s,e.label=12;case 12:if(!(a<i.length))return[3,17];o=i[a],e.label=13;case 13:return e.trys.push([13,15,,16]),[4,g.default.move(o.from,o.to,{overwrite:!0})];case 14:case 15:return e.sent(),[3,16];case 16:return a++,[3,12];case 17:return[2]}}))}))}]}];function A(r){return e.__awaiter(this,void 0,void 0,(function(){var t,n,s,a;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(t=U.find((function(e){return j.default.satisfies(r.previousVersion,e.version)}))))return[2];x("Refactoring from "+t.version),n=0,s=t.steps,e.label=1;case 1:return n<s.length?(a=s[n],x("Refactoring step"),[4,a({version:t.version,inputFile:r.inputFile,unpackDir:r.unpackDir,appRoot:r.appRoot})]):[3,4];case 2:e.sent(),e.label=3;case 3:return n++,[3,1];case 4:return[4,O({inputFile:r.inputFile,unpackDir:r.unpackDir,appRoot:r.appRoot})];case 5:return e.sent(),x("Refactoring complete"),[2]}}))}))}var S={source:function(r,t){return e.__awaiter(void 0,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,J(r,t)];case 1:return e.sent(),[2]}}))}))},test:function(r,t){return e.__awaiter(void 0,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,J(r,t)];case 1:return e.sent(),[2]}}))}))},json:function(r,t){return e.__awaiter(void 0,void 0,void 0,(function(){var n,s,a;return e.__generator(this,(function(e){switch(e.label){case 0:return q("Updating: "+t),t.endsWith("package.json")?[4,g.default.readJson(r)]:[3,4];case 1:return n=e.sent(),[4,g.default.readJson(t).catch((function(){return n}))];case 2:return s=e.sent(),a=E(s,n),[4,g.default.outputFile(t,JSON.stringify(a,null,2))];case 3:return e.sent(),[3,6];case 4:return[4,g.default.copy(r,t)];case 5:e.sent(),e.label=6;case 6:return[2]}}))}))},yaml:function(r,t,n){return e.__awaiter(void 0,void 0,void 0,(function(){var s,a,i;return e.__generator(this,(function(o){switch(o.label){case 0:return q("Updating: "+t),t.endsWith("docker-compose.yml")?[4,g.default.readFile(r)]:[3,4];case 1:return s=o.sent().toString(),[4,g.default.readFile(t).catch((function(){return s}))];case 2:return a=o.sent().toString(),i=function(r,t){var n=e.__assign({version:"3",services:{}},r);return n.services.mongo&&(n.services.mongo=t.services.mongo),n.services.db&&(n.services.db=t.services.db),Object.keys(n.services).length||delete n.services,n}(D.default.parse(a),D.default.parse(s)),[4,g.default.outputFile(t,D.default.stringify(i))];case 3:return o.sent(),[3,8];case 4:return j.default.satisfies(n,"<=1.25.0")?[4,g.default.copy(r,t,{overwrite:!0})]:[3,6];case 5:return o.sent(),[2];case 6:return[4,J(r,t)];case 7:o.sent(),o.label=8;case 8:return[2]}}))}))},dot:function(r,t){return e.__awaiter(void 0,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,J(r,t)];case 1:return e.sent(),[2]}}))}))},delete:function(r,t){return e.__awaiter(void 0,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return t.includes(".gitignore")?[2]:(q("Deleting: "+t),[4,g.default.remove(t)]);case 1:return e.sent(),[2]}}))}))},copy:function(r,t,n){return e.__awaiter(void 0,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return j.default.satisfies(n,"<=1.25.0")?[4,g.default.copy(r,t,{overwrite:!0})]:[3,2];case 1:return e.sent(),[2];case 2:return[4,J(r,t)];case 3:return e.sent(),[2]}}))}))}};function z(r){return e.__awaiter(this,void 0,void 0,(function(){var t,n,s,a,i,o,u,c,l;return e.__generator(this,(function(d){switch(d.label){case 0:return x("Installing Project"),[4,g.default.readJson(h.default.resolve(r.appRoot,"package.json"))];case 1:return t=d.sent(),n=t["graph-mind-version-prev"]||t["graph-mind-version"]||"0.0.0",[4,A(e.__assign(e.__assign({},r),{previousVersion:n}))];case 2:return d.sent(),[4,g.default.readJson(h.default.resolve(r.unpackDir,"files.json"))];case 3:s=d.sent(),a=0,i=s,d.label=4;case 4:if(!(a<i.length))return[3,9];if(o=i[a],u=h.default.resolve(r.appRoot,o.path),c=h.default.resolve(r.unpackDir,o.path),!(l=S[o.type]))return[3,8];d.label=5;case 5:return d.trys.push([5,7,,8]),[4,l(c,u,n)];case 6:case 7:return d.sent(),[3,8];case 8:return a++,[3,4];case 9:return[4,g.default.remove(h.default.resolve(r.appRoot,"gitignore")).catch((function(){}))];case 10:return d.sent(),[4,g.default.remove(h.default.resolve(r.appRoot,"files.json")).catch((function(){}))];case 11:return d.sent(),[2]}}))}))}function I(r){return e.__awaiter(this,void 0,void 0,(function(){var t,n;return e.__generator(this,(function(e){switch(e.label){case 0:if(x("Checking for git"),!p.sync("git"))return[2];e.label=1;case 1:return e.trys.push([1,3,,4]),x("Checking for git repo"),[4,(t=F.default(r.appRoot)).status().then((function(){return!0})).catch((function(){return!1}))];case 2:return n=e.sent(),[3,4];case 3:return e.sent(),[2];case 4:if(n)return[2];e.label=5;case 5:return e.trys.push([5,9,,10]),x("Initializing git repo"),[4,t.init(!1,{"--initial-branch":"master"})];case 6:return e.sent(),[4,t.add([".gitignore"])];case 7:return e.sent(),[4,t.commit("chore: init repository")];case 8:return e.sent(),x("Initialized git repo"),[3,10];case 9:return e.sent(),x("Git Error"),[3,10];case 10:return[2]}}))}))}function P(){return e.__awaiter(this,void 0,void 0,(function(){var r;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,k.default.exec("yarn --version",{silent:!0}).stdout];case 1:return r=(r=e.sent()).trim(),/^1\.[0-9]+\.[0-9]+$/.test(r)?[4,k.default.exec("yarn install")]:[2,!1];case 2:return e.sent(),[2,!0]}}))}))}function B(){return e.__awaiter(this,void 0,void 0,(function(){var r;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,k.default.exec("npm --version",{silent:!0}).stdout];case 1:return r=(r=e.sent()).trim(),/^[7-9]\.[0-9]+\.[0-9]+$/.test(r)?[4,k.default.exec("npm install")]:[2,!1];case 2:return e.sent(),[2,!0]}}))}))}function N(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,g.default.pathExists("yarn.lock")];case 1:return e.sent()?[4,P()]:[3,3];case 2:return e.sent(),[2];case 3:return!1,[4,B()];case 4:return e.sent()?[2]:[4,P()];case 5:return e.sent(),[2]}}))}))}function W(r){return e.__awaiter(this,void 0,void 0,(function(){var t,n,s,a,i,o,u=this;return e.__generator(this,(function(c){switch(c.label){case 0:return t=r.inputFile.slice(r.appRoot.length+1),n=r.inputFile,[4,g.default.pathExists(n)];case 1:if(!c.sent())throw new Error("Bundle ("+n+") does not exist, please check the bundle is in the project folder.");x("Unpacking project"),c.label=2;case 2:return c.trys.push([2,4,,5]),[4,g.default.createReadStream(n).pipe(y.default.Extract({path:r.unpackDir})).promise()];case 3:return c.sent(),[3,5];case 4:throw c.sent(),new Error("An error occurred while processing the bundle");case 5:return x("Updating ada"),[4,new Promise((function(e,t){b.default("/packages/ada/**/*",{cwd:r.unpackDir},(function(r,n){r?t(r):e(n)}))}))];case 6:return s=c.sent(),[4,Promise.all(s.map((function(t){return e.__awaiter(u,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return n=h.default.resolve(r.appRoot,t.slice(r.unpackDir.length+1)),[4,g.default.copy(t,n,{overwrite:!0})];case 1:return e.sent(),[2]}}))}))})))];case 7:return c.sent(),[4,g.default.readJson(h.default.resolve(r.appRoot,"package.json"))];case 8:return a=c.sent(),[4,g.default.readJson(h.default.resolve(r.unpackDir,"package.json"))];case 9:return i=c.sent(),o=E(a,i),x("Comparing versions"),a["graph-mind-version"]===o["graph-mind-version"]?[3,13]:(x("Running new version of Ada"),o.dependencies=a.dependencies,o.devDependencies=a.devDependencies,[4,g.default.outputFile(h.default.resolve(r.appRoot,"package.json"),JSON.stringify(o,null,2))]);case 10:return c.sent(),x("Installing dependencies"),[4,N()];case 11:return c.sent(),x("Updating project"),[4,k.default.exec("node ./packages/ada install ./"+t)];case 12:return c.sent(),[2];case 13:return c.trys.push([13,15,,16]),[4,g.default.copy(h.default.resolve(r.unpackDir,"gitignore"),h.default.resolve(r.appRoot,".gitignore"),{overwrite:!0})];case 14:case 15:return c.sent(),[3,16];case 16:return[4,I({inputFile:r.inputFile,unpackDir:r.unpackDir,appRoot:r.appRoot})];case 17:return c.sent(),[4,z({inputFile:r.inputFile,unpackDir:r.unpackDir,appRoot:r.appRoot})];case 18:return c.sent(),o["graph-mind-version-prev"]=o["graph-mind-version"],[4,g.default.outputFile(h.default.resolve(r.appRoot,"package.json"),JSON.stringify(o,null,2))];case 19:return c.sent(),[2]}}))}))}var $=m.default("Ada");$.version("1.0.0"),$.command("install [project]").action((function(r){return e.__awaiter(void 0,void 0,void 0,(function(){var t,n,s,a;return e.__generator(this,(function(e){switch(e.label){case 0:if(t=r?h.default.resolve(r):h.default.join(process.cwd(),"./project.zip"),!/\.(zip)$/.test(t))throw new Error("Input must be a project zip file");if(!(n=_.default.sync({cwd:t})))throw new Error("Package.json not found.");n=h.default.resolve(n,"../"),s=h.default.resolve(__dirname,".ada"),e.label=1;case 1:return e.trys.push([1,3,5,7]),[4,W({inputFile:t,unpackDir:s,appRoot:n})];case 2:return e.sent(),[3,7];case 3:return a=e.sent(),x("Error!"),[4,g.default.remove(s)];case 4:throw e.sent(),a;case 5:return[4,g.default.remove(s)];case 6:return e.sent(),[7];case 7:return x("Success!"),[2]}}))}))})),$.parse(process.argv);